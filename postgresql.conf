
# Configuração otimizada para inserções constantes com recursos limitados
# CPU: 0.75 cores, RAM: 1.5GB

# === CONEXÕES ===
max_connections = 100                    # Reduzido para economizar memória
superuser_reserved_connections = 3

# === MEMÓRIA ===
shared_buffers = 384MB                   # ~25% da RAM disponível (1.5GB)
effective_cache_size = 1GB               # ~67% da RAM total
work_mem = 4MB                          # Reduzido drasticamente (100 conexões * 4MB = 400MB max)
maintenance_work_mem = 128MB             # Aumentado para operações de manutenção
temp_buffers = 8MB                      # Buffer para tabelas temporárias

# === WAL (Write-Ahead Logging) - CRÍTICO para inserções ===
wal_buffers = 16MB                      # Aumentado significativamente para inserções
wal_writer_delay = 10ms                 # Flush mais frequente do WAL
wal_writer_flush_after = 1MB            # Flush após 1MB de dados
commit_delay = 100                      # Micro delay para agrupar commits
commit_siblings = 10                    # Número de transações para ativar commit_delay

# === CHECKPOINT - Otimizado para inserções constantes ===
checkpoint_completion_target = 0.9       # Distribuir checkpoint ao longo do tempo
checkpoint_timeout = 15min              # Checkpoint mais frequente
checkpoint_flush_after = 256kB          # Flush incremental durante checkpoint
checkpoint_warning = 30s               # Aviso se checkpoint demorar muito

# === WAL ARCHIVING ===
min_wal_size = 512MB                    # Reduzido para economizar espaço
max_wal_size = 2GB                      # Reduzido mas ainda adequado
wal_keep_size = 128MB                   # Manter WAL para replicação

# === BACKGROUND WRITER ===
bgwriter_delay = 50ms                   # Mais agressivo para inserções constantes
bgwriter_lru_maxpages = 200             # Mais páginas por round
bgwriter_lru_multiplier = 4.0           # Mais agressivo na limpeza
bgwriter_flush_after = 512kB            # Flush mais frequente

# === AUTOVACUUM - Crítico para inserções constantes ===
autovacuum = on
autovacuum_max_workers = 2              # Limitado devido aos recursos
autovacuum_naptime = 30s                # Mais frequente para lidar com inserções
autovacuum_vacuum_threshold = 25        # Threshold menor
autovacuum_vacuum_scale_factor = 0.1    # 10% da tabela
autovacuum_analyze_threshold = 25       # Análise mais frequente
autovacuum_analyze_scale_factor = 0.05  # 5% da tabela
autovacuum_vacuum_cost_delay = 10ms     # Mais agressivo
autovacuum_vacuum_cost_limit = 1000     # Limite maior

# === PLANNER ===
default_statistics_target = 100
random_page_cost = 1.1                  # SSD otimizado
seq_page_cost = 1.0
cpu_tuple_cost = 0.01
cpu_index_tuple_cost = 0.005
cpu_operator_cost = 0.0025
effective_io_concurrency = 200          # Para SSD

# === CONEXÕES DE REDE ===
listen_addresses = '*'
tcp_keepalives_idle = 60
tcp_keepalives_interval = 10
tcp_keepalives_count = 10
tcp_user_timeout = 30000                # 30 segundos timeout

# === LOGGING - Reduzido para performance ===
log_min_duration_statement = 1000       # Apenas queries > 1s
log_checkpoints = on                    # Monitorar checkpoints
log_connections = off                   # Desabilitado para performance
log_disconnections = off                # Desabilitado para performance
log_lock_waits = on                     # Monitorar locks
log_temp_files = 10MB                   # Log apenas arquivos temp grandes

# === PERFORMANCE ESPECÍFICA PARA INSERÇÕES ===
synchronous_commit = off                # CRÍTICO: Async commit para inserções rápidas
fsync = on                             # Manter para durabilidade
full_page_writes = on                  # Necessário para consistência
wal_compression = on                   # Comprimir WAL para economizar I/O
wal_init_zero = off                    # Não zerar WAL files (performance)
wal_recycle = on                       # Reciclar WAL files

# === LOCKS ===
deadlock_timeout = 1s                  # Detecção rápida de deadlocks
lock_timeout = 30s                     # Timeout para locks
idle_in_transaction_session_timeout = 300s  # Limpar transações idle

# === RECURSOS DO SISTEMA ===
huge_pages = try                       # Tentar usar huge pages se disponível
shared_preload_libraries = ''          # Vazio para economizar recursos
